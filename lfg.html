<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        .btn:active {
            transform: scale(0.95);
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }

        @keyframes rainbow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        body {
            background: linear-gradient(270deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 1400% 1400%;
            animation: rainbow 60s ease infinite;
        }

        .login-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen">
    <div class="login-container hidden">
        <button id="google-login" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">Login dengan Google</button>
        <button id="logout" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>
    <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto w-full max-w-7xl" id="timer-table-container">
        <table class="min-w-full divide-y divide-gray-200" id="timer-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Timer</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stop</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hapus</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
        <div class="mt-4 text-center">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Tambah Tabel Baru</button>
        </div>
    </div>
    <script>
        // (function() {
        //  emailjs.init("YOUR_USER_ID"); // Replace with your EmailJS user ID
        // })();

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDXjv3Yg8RJvxCrYYZvMjpEKSdxcshynTo",
            authDomain: "pangestu-timer.firebaseapp.com",
            projectId: "pangestu-timer",
            storageBucket: "pangestu-timer.firebasestorage.app",
            messagingSenderId: "423055274704",
            appId: "1:423055274704:web:3e9e438bc18439012364d5",
            measurementId: "G-0249BJFL8T" // Optional, but included
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const loginContainer = document.querySelector('.login-container');
        const timerTableContainer = document.getElementById('timer-table-container');
        const googleLoginButton = document.getElementById('google-login');
        const logoutButton = document.getElementById('logout');

        function formatTime(totalSeconds) {
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function parseTimeString(timeString) {
            const [h, m, s] = timeString.split(':').map(Number);
            return (h * 3600) + (m * 60) + s;
        }

        let currentUserId = null;

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
                console.log('User signed in:', user.uid);
                loadTimersForUser(currentUserId);
                // Tampilkan UI timer
                document.querySelector('.login-container').classList.add('hidden');
                document.querySelector('#timer-table-container').classList.remove('hidden');
            } else {
                currentUserId = null;
                console.log('No user signed in.');
                // Sembunyikan UI timer
                document.querySelector('.login-container').classList.remove('hidden');
                document.querySelector('#timer-table-container').classList.add('hidden');
                // Bersihkan tabel timer
                document.querySelector('#timer-table tbody').innerHTML = '';
            }
        });

        function startTimer(row, timerId) {
            if (!currentUserId) {
                alert('Silakan login terlebih dahulu.');
                return;
            }
            const nameInput = row.querySelector('input[type="text"]');
            const timerElement = row.querySelector('.timer');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            let totalSeconds = parseTimeString(timerElement.textContent);
            const startTime = Date.now();
            const timerData = {
                name: nameInput.value,
                duration: totalSeconds,
                startTime: startTime,
                isRunning: true
            };

            const timerRef = database.ref(`users/${currentUserId}/timers/${timerId}`);
            timerRef.set(timerData)
                .then(() => {
                    startButton.disabled = true;
                    startButton.classList.add('bg-green-500', 'text-white');
                    stopButton.disabled = false;
                    startCountdown(row, timerId, totalSeconds, startTime);
                })
                .catch(error => console.error('Error saving timer:', error));
        }

        function stopTimer(row, timerId) {
            if (!currentUserId) return;
            const timerElement = row.querySelector('.timer');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const timerRef = database.ref(`users/${currentUserId}/timers/${timerId}`);

            timerRef.child('isRunning').set(false)
                .then(() => {
                    clearInterval(row.intervalId);
                    startButton.disabled = false;
                    startButton.classList.remove('bg-green-500', 'text-white');
                    stopButton.disabled = true;
                    // Mungkin simpan waktu yang tersisa jika perlu
                })
                .catch(error => console.error('Error stopping timer:', error));
        }

        function deleteTimer(row, timerId) {
            if (!currentUserId) return;
            const timerRef = database.ref(`users/${currentUserId}/timers/${timerId}`);
            timerRef.remove()
                .then(() => {
                    row.remove();
                    // ... update UI ...
                })
                .catch(error => console.error('Error deleting timer:', error));
        }

        function loadTimersForUser(userId) {
            if (!userId) return;
            const timersRef = database.ref(`users/${userId}/timers`);
            timersRef.on('value', (snapshot) => {
                const tableBody = document.querySelector('#timer-table tbody');
                tableBody.innerHTML = ''; // Clear existing rows
                const timers = snapshot.val();
                if (timers) {
                    let index = 1;
                    for (const key in timers) {
                        if (timers.hasOwnProperty(key)) {
                            const timerData = timers[key];
                            const remainingTime = timerData.isRunning && timerData.startTime ? Math.max(0, timerData.duration - Math.floor((Date.now() - timerData.startTime) / 1000)) : parseTimeString(formatTime(timerData.duration));
                            addRowWithData(timerData.name, formatTime(timerData.duration), timerData.isRunning, timerData.startTime, key);
                            // You might need to adjust the display of the timer based on isRunning and startTime
                        }
                    }
                    updateRowNumbers();
                }
            });
        }

        function addRowWithData(name, duration, isRunning, startTime, timerId) {
            const tableBody = document.querySelector('#timer-table tbody');
            const newRow = document.createElement('tr');
            const timerDisplay = isRunning && startTime ? formatTime(Math.max(0, parseTimeString(duration) - Math.floor((Date.now() - startTime) / 1000) / 1000)) : formatTime(parseTimeString(duration));
            newRow.id = `timer-row-${timerId}`;
            newRow.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${tableBody.children.length + 1}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <input type="text" placeholder="Masukkan Nama" class="border border-gray-300 rounded px-2 py-1 w-full" value="${name}">
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg">${timerDisplay}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full" ${isRunning ? 'disabled' : ''}>Mulai</button>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" ${!isRunning ? 'disabled' : ''}>Stop</button>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
        </td>
    `;
            tableBody.appendChild(newRow);
            const startButton = newRow.querySelector('.start-btn');
            const stopButton = newRow.querySelector('.stop-btn');
            const deleteButton = newRow.querySelector('.delete-btn');
            const timerElement = newRow.querySelector('.timer');
            const nameInput = newRow.querySelector('input[type="text"]');

            startButton.addEventListener('click', () => startTimer(newRow, timerId));
            stopButton.addEventListener('click', () => stopTimer(newRow, timerId));
            deleteButton.addEventListener('click', () => deleteTimer(newRow, timerId));
            nameInput.addEventListener('input', () => {
                if (currentUserId) {
                    database.ref(`users/${currentUserId}/timers/${timerId}/name`).set(nameInput.value);
                }
            });
        }

        function startCountdown(row, timerId, totalSeconds, startTime) {
            const timerElement = row.querySelector('.timer');
            row.intervalId = setInterval(() => {
                totalSeconds--;
                const remainingTime = Math.max(0, totalSeconds);
                timerElement.textContent = formatTime(remainingTime);
                if (remainingTime <= 0) {
                    clearInterval(row.intervalId);
                    // Lakukan sesuatu saat timer selesai (misalnya, notifikasi)
                    database.ref(`users/${currentUserId}/timers/${timerId}/isRunning`).set(false);
                    const startButton = row.querySelector('.start-btn');
                    const stopButton = row.querySelector('.stop-btn');
                    startButton.disabled = false;
                    startButton.classList.remove('bg-green-500', 'text-white');
                    stopButton.disabled = true;
                }
                // Optional: Update duration in Firebase
                // database.ref(`users/${currentUserId}/timers/${timerId}/duration`).set(remainingTime);
            }, 1000);
        }

        function startCountdownForExisting(row, timerId, duration, startTime) {
            const timerElement = row.querySelector('.timer');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            let remainingSeconds = Math.max(0, Math.floor(duration) - elapsedSeconds); // Changed duration to seconds
            timerElement.textContent = formatTime(remainingSeconds);
            startButton.disabled = true;
            startButton.classList.add('bg-green-500', 'text-white');
            stopButton.disabled = false;

            row.intervalId = setInterval(() => {
                remainingSeconds--;
                timerElement.textContent = formatTime(Math.max(0, remainingSeconds));
                if (remainingSeconds <= 0) {
                    clearInterval(row.intervalId);
                    database.ref(`users/${currentUserId}/timers/${timerId}/isRunning`).set(false);
                    startButton.disabled = false;
                    startButton.classList.remove('bg-green-500', 'text-white');
                    stopButton.disabled = true;
                }
            }, 1000);
        }

        function stopCountdownForExisting(row) {
            clearInterval(row.intervalId);
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            startButton.disabled = false;
            startButton.classList.remove('bg-green-500', 'text-white');
            stopButton.disabled = true;
        }

        function updateRowNumbers() {
            document.querySelectorAll('#timer-table tbody tr').forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }

        document.getElementById('add-row-btn').addEventListener('click', () => {
            if (currentUserId) {
                const newTimerId = database.ref(`users/${currentUserId}/timers`).push().key; // Generate unique ID
                addRowWithData('', '00:00:00', false, null, newTimerId);
            } else {
                alert('Silakan login terlebih dahulu untuk menambahkan timer.');
            }
        });
    </script>
</body>
</html>