<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tambahkan Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAEvZsHU6gBfycu-uEt2sb42xzRvgR7_Ww",
            authDomain: "namas-timer.firebaseapp.com",
            projectId: "namas-timer",
            storageBucket: "namas-timer.appspot.com",
            messagingSenderId: "663877981459",
            appId: "1:663877981459:web:08bdcb0664652a82eaf6e6",
            measurementId: "G-Q6H1HTKHC6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Ekspor fungsi-fungsi Firebase yang diperlukan
        window.firebase = {
            db: database,
            ref,
            set,
            onValue,
            push,
            remove,
            update
        };
    </script>
    <style>
        .btn:active {
            transform: scale(0.95);
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            background: linear-gradient(270deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 1400% 1400%;
            animation: rainbow 60s ease infinite;
        }
        #alarm-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: red;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto w-full max-w-7xl">
        <div class="text-center mb-4">
            <div id="date-time" class="text-lg font-semibold"></div>
        </div>
        <table class="min-w-full divide-y divide-gray-200" id="timer-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Timer</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stop</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hapus</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
        <div class="mt-4 text-center">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Tambah Tabel Baru</button>
        </div>
    </div>
    <audio id="alarm-sound" src="./alarm.mp3" preload="auto"></audio>
    <div id="alarm-box">Alarm</div>
    <script>
        // Variabel global untuk menyimpan interval timer
        const activeTimers = {};

        function playAlarm() {
            const alarmSound = document.getElementById('alarm-sound');
            const alarmBox = document.getElementById('alarm-box');
            alarmSound.play();
            alarmBox.style.display = 'block';

            alarmBox.addEventListener('click', () => {
                alarmSound.pause();
                alarmSound.currentTime = 0;
                alarmBox.style.display = 'none';
            });
        }

        function addEventListenersToRow(row, rowId) {
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const deleteButton = row.querySelector('.delete-btn');
            const timerElement = row.querySelector('.timer');
            const timerInput = row.querySelector('.timer-input');
            const nameInput = row.querySelector('input[type="text"]');

            startButton.addEventListener('click', () => {
                let [hours, minutes, seconds] = timerInput.value.split(':').map(Number);
                let totalSeconds = hours * 3600 + minutes * 60 + seconds;

                timerElement.textContent = timerInput.value;
                timerInput.classList.add('hidden');
                timerElement.classList.remove('hidden');

                // Hentikan timer sebelumnya jika ada
                if (activeTimers[rowId]) {
                    clearInterval(activeTimers[rowId]);
                }

                // Mulai timer baru
                activeTimers[rowId] = setInterval(() => {
                    if (totalSeconds <= 0) {
                        clearInterval(activeTimers[rowId]);
                        playAlarm();
                        // Update status di Firebase
                        updateTimerInFirebase(rowId, {
                            timer: timerElement.textContent,
                            startDisabled: false,
                            stopDisabled: true,
                            isRunning: false
                        });
                        return;
                    }
                    totalSeconds--;
                    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                    const s = String(totalSeconds % 60).padStart(2, '0');
                    timerElement.textContent = `${h}:${m}:${s}`;
                    
                    // Update timer di Firebase setiap detik
                    updateTimerInFirebase(rowId, {
                        timer: timerElement.textContent,
                        remainingSeconds: totalSeconds
                    });
                }, 1000);

                startButton.disabled = true;
                startButton.classList.add('bg-green-500', 'text-white');
                stopButton.disabled = false;

                // Update status di Firebase
                updateTimerInFirebase(rowId, {
                    startDisabled: true,
                    stopDisabled: false,
                    isRunning: true,
                    remainingSeconds: totalSeconds
                });
            });

            stopButton.addEventListener('click', () => {
                if (activeTimers[rowId]) {
                    clearInterval(activeTimers[rowId]);
                    delete activeTimers[rowId];
                }
                startButton.disabled = false;
                startButton.classList.remove('bg-green-500', 'text-white');
                stopButton.disabled = true;

                // Update status di Firebase
                updateTimerInFirebase(rowId, {
                    startDisabled: false,
                    stopDisabled: true,
                    isRunning: false,
                    timer: timerElement.textContent
                });
            });

            deleteButton.addEventListener('click', () => {
                if (activeTimers[rowId]) {
                    clearInterval(activeTimers[rowId]);
                    delete activeTimers[rowId];
                }
                deleteTimerFromFirebase(rowId);
                row.remove();
                updateRowNumbers();
            });

            nameInput.addEventListener('input', () => {
                updateTimerInFirebase(rowId, {
                    name: nameInput.value
                });
            });
        }

        function updateRowNumbers() {
            document.querySelectorAll('#timer-table tbody tr').forEach((row, index) => {
                row.querySelector('td').textContent = index + 1;
            });
        }

        // Fungsi Firebase
        function addTimerToFirebase(timerData) {
            const newTimerRef = firebase.push(firebase.ref(firebase.db, 'timers'));
            firebase.set(newTimerRef, timerData);
            return newTimerRef.key; // Mengembalikan ID unik
        }

        function updateTimerInFirebase(timerId, updates) {
            const timerRef = firebase.ref(firebase.db, `timers/${timerId}`);
            firebase.update(timerRef, updates);
        }

        function deleteTimerFromFirebase(timerId) {
            const timerRef = firebase.ref(firebase.db, `timers/${timerId}`);
            firebase.remove(timerRef);
        }

        function loadTimersFromFirebase() {
            const timersRef = firebase.ref(firebase.db, 'timers');
            firebase.onValue(timersRef, (snapshot) => {
                const timers = snapshot.val();
                const tableBody = document.querySelector('#timer-table tbody');
                tableBody.innerHTML = ''; // Kosongkan tabel
                
                if (timers) {
                    Object.keys(timers).forEach((timerId) => {
                        const timer = timers[timerId];
                        const newRow = document.createElement('tr');
                        newRow.setAttribute('data-id', timerId);
                        
                        newRow.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${timer.no || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <input type="text" placeholder="Masukkan Nama" class="border border-gray-300 rounded px-2 py-1 w-full" value="${timer.name || ''}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <input type="text" placeholder="HH:MM:SS" class="border border-gray-300 rounded px-2 py-1 w-full timer-input" value="${timer.initialTime || '24:00:00'}">
                                <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg ${timer.isRunning ? '' : 'hidden'}">${timer.timer || '24:00:00'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full" ${timer.startDisabled ? 'disabled' : ''}>Mulai</button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" ${timer.stopDisabled ? 'disabled' : ''}>Stop</button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
                            </td>
                        `;
                        
                        tableBody.appendChild(newRow);
                        addEventListenersToRow(newRow, timerId);
                        
                        // Jika timer sedang berjalan, mulai ulang countdown
                        if (timer.isRunning && timer.remainingSeconds) {
                            const timerElement = newRow.querySelector('.timer');
                            const startButton = newRow.querySelector('.start-btn');
                            const stopButton = newRow.querySelector('.stop-btn');
                            const timerInput = newRow.querySelector('.timer-input');
                            
                            timerInput.classList.add('hidden');
                            timerElement.classList.remove('hidden');
                            startButton.disabled = true;
                            startButton.classList.add('bg-green-500', 'text-white');
                            stopButton.disabled = false;
                            
                            let totalSeconds = timer.remainingSeconds;
                            
                            // Hentikan timer sebelumnya jika ada
                            if (activeTimers[timerId]) {
                                clearInterval(activeTimers[timerId]);
                            }
                            
                            // Mulai timer baru
                            activeTimers[timerId] = setInterval(() => {
                                if (totalSeconds <= 0) {
                                    clearInterval(activeTimers[timerId]);
                                    delete activeTimers[timerId];
                                    playAlarm();
                                    updateTimerInFirebase(timerId, {
                                        startDisabled: false,
                                        stopDisabled: true,
                                        isRunning: false
                                    });
                                    return;
                                }
                                totalSeconds--;
                                const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                                const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                                const s = String(totalSeconds % 60).padStart(2, '0');
                                timerElement.textContent = `${h}:${m}:${s}`;
                                
                                updateTimerInFirebase(timerId, {
                                    timer: timerElement.textContent,
                                    remainingSeconds: totalSeconds
                                });
                            }, 1000);
                        }
                    });
                }
                updateRowNumbers();
            });
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Jakarta' };
            const formattedDateTime = now.toLocaleDateString('id-ID', options);
            document.getElementById('date-time').textContent = formattedDateTime;
        }

        document.getElementById('add-row-btn').addEventListener('click', () => {
            const tableBody = document.querySelector('#timer-table tbody');
            const rowCount = tableBody.rows.length + 1;
            
            const newTimerData = {
                no: rowCount,
                name: '',
                timer: '24:00:00',
                initialTime: '24:00:00',
                startDisabled: false,
                stopDisabled: true,
                isRunning: false
            };
            
            const timerId = addTimerToFirebase(newTimerData);
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('start-btn')) {
                const row = event.target.closest('tr');
                const timerInput = row.querySelector('.timer-input');
                const timerElement = row.querySelector('.timer');
                timerElement.textContent = timerInput.value;
                timerInput.classList.add('hidden');
                timerElement.classList.remove('hidden');
            }
        });

        window.addEventListener('load', () => {
            loadTimersFromFirebase();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });
    </script>
</body>
</html>
