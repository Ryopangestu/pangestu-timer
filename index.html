<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table with Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEvZsHU6gBfycu-uEt2sb42xzRvgR7_Ww",
            authDomain: "namas-timer.firebaseapp.com",
            projectId: "namas-timer",
            storageBucket: "namas-timer.appspot.com",
            messagingSenderId: "663877981459",
            appId: "1:663877981459:web:08bdcb0664652a82eaf6e6",
            measurementId: "G-Q6H1HTKHC6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firestore helpers
        const timerCollection = collection(db, "timers");

        async function saveRowToFirestore(data) {
            await addDoc(timerCollection, data);
        }

        async function updateRowInFirestore(id, data) {
            const docRef = doc(db, "timers", id);
            await updateDoc(docRef, data);
        }

        async function deleteRowFromFirestore(id) {
            const docRef = doc(db, "timers", id);
            await deleteDoc(docRef);
        }

        async function fetchRowsFromFirestore() {
            const querySnapshot = await getDocs(timerCollection);
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        window.addEventListener('load', async () => {
            const rows = await fetchRowsFromFirestore();
            rows.forEach(row => renderRow(row));
        });

        function renderRow(data) {
            const tableBody = document.querySelector('#timer-table tbody');
            const newRow = document.createElement('tr');
            newRow.dataset.id = data.id; // Store Firestore document ID
            newRow.innerHTML = `
                <td class="px-6 py-4 text-center">${data.no}</td>
                <td class="px-6 py-4 text-center">
                    <input type="text" value="${data.name}" class="border rounded w-full px-2 py-1">
                </td>
                <td class="px-6 py-4 text-center">
                    <input type="text" value="${data.timer}" class="border rounded w-full px-2 py-1 timer-input hidden">
                    <div class="timer">${data.timer}</div>
                </td>
                <td class="px-6 py-4 text-center">
                    <button class="start-btn btn">Mulai</button>
                </td>
                <td class="px-6 py-4 text-center">
                    <button class="stop-btn btn" disabled>Stop</button>
                </td>
                <td class="px-6 py-4 text-center">
                    <button class="delete-btn btn bg-red-500 text-white">Hapus</button>
                </td>
            `;
            tableBody.appendChild(newRow);
            addEventListenersToRow(newRow);
        }

        document.getElementById('add-row-btn').addEventListener('click', async () => {
            const tableBody = document.querySelector('#timer-table tbody');
            const rowCount = tableBody.rows.length + 1;
            const data = {
                no: rowCount,
                name: "Nama Timer",
                timer: "24:00:00",
                startDisabled: false,
                stopDisabled: true
            };

            const docRef = await addDoc(timerCollection, data);
            data.id = docRef.id; // Assign Firestore document ID
            renderRow(data);
        });

        function addEventListenersToRow(row) {
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const deleteButton = row.querySelector('.delete-btn');
            const timerElement = row.querySelector('.timer');
            const timerInput = row.querySelector('.timer-input');
            const nameInput = row.querySelector('input[type="text"]');
            const rowId = row.dataset.id;

            let interval;

            startButton.addEventListener('click', async () => {
                const timerValue = timerInput.value;
                let [hours, minutes, seconds] = timerValue.split(':').map(Number);
                let totalSeconds = hours * 3600 + minutes * 60 + seconds;

                timerElement.textContent = timerValue;
                timerInput.classList.add('hidden');
                timerElement.classList.remove('hidden');

                interval = setInterval(async () => {
                    if (totalSeconds <= 0) {
                        clearInterval(interval);
                        alert("Timer selesai!");
                        return;
                    }
                    totalSeconds--;
                    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                    const s = String(totalSeconds % 60).padStart(2, '0');
                    timerElement.textContent = `${h}:${m}:${s}`;
                    await updateRowInFirestore(rowId, { timer: `${h}:${m}:${s}` });
                }, 1000);

                startButton.disabled = true;
                stopButton.disabled = false;
            });

            stopButton.addEventListener('click', () => {
                clearInterval(interval);
                startButton.disabled = false;
                stopButton.disabled = true;
            });

            deleteButton.addEventListener('click', async () => {
                row.remove();
                await deleteRowFromFirestore(rowId);
            });

            nameInput.addEventListener('input', async () => {
                const name = nameInput.value;
                await updateRowInFirestore(rowId, { name });
            });
        }
    </script>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-lg p-4 w-full max-w-5xl">
        <table class="w-full divide-y divide-gray-200" id="timer-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 text-center uppercase">No</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 text-center uppercase">Nama</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 text-center uppercase">Timer</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 text-center uppercase">Mulai</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 text-center uppercase">Stop</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 text-center uppercase">Hapus</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
        <div class="mt-4 text-center">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Tambah Timer</button>
        </div>
    </div>
</body>
</html>
