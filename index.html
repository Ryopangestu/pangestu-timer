<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table with Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        .btn:active {
            transform: scale(0.95);
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        
        .timer-display-box {
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            display: inline-block;
            min-width: 100px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            background-color: #ecfdf5;
            color: #047857;
        }
        
        .finish-time-box {
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            display: inline-block;
            min-width: 150px;
            text-align: center;
            font-weight: bold;
            background-color: #ecfdf5;
            color: #047857;
        }
        
        .name-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            min-width: 150px;
            background-color: white;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        .connection-online {
            background-color: #10B981;
            color: white;
            display: block;
        }
        .connection-offline {
            background-color: #EF4444;
            color: white;
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-green-500 to-green-700">
    <div class="main-container bg-white rounded-lg shadow-lg p-4 mx-auto my-4 w-full max-w-7xl">
        <!-- Konten utama tetap sama seperti sebelumnya -->
        <div class="text-center mb-4">
            <div id="date-time" class="text-lg font-semibold"></div>
        </div>
        
        <div class="table-container overflow-x-auto mb-4 max-h-[60vh]">
            <table class="min-w-full divide-y divide-gray-200" id="timer-table">
                <thead class="table-header bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-center">No</th>
                        <th class="px-4 py-3 text-center">Nama</th>
                        <th class="px-4 py-3 text-center">Set Timer</th>
                        <th class="px-4 py-3 text-center">Timer Berjalan</th>
                        <th class="px-4 py-3 text-center">Selesai Pada</th>
                        <th class="px-4 py-3 text-center">Mulai</th>
                        <th class="px-4 py-3 text-center">Stop</th>
                        <th class="px-4 py-3 text-center">Restart</th>
                        <th class="px-4 py-3 text-center">Hapus</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be added dynamically -->
                </tbody>
            </table>
        </div>

        <div class="text-center mb-4">
            <button id="add-row-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                Tambah Tabel Baru
            </button>
        </div>

        <div class="converter-container bg-white bg-opacity-90 rounded-lg p-4 mt-4 shadow">
            <div class="converter-title text-lg font-bold mb-2">Konverter Waktu WIB ⇄ UTC</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <input type="time" id="wib-time" class="time-input border border-gray-300 rounded px-3 py-2 w-full" step="1">
                    <button id="wib-to-utc" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded w-full mt-1">
                        WIB → UTC
                    </button>
                </div>
                <div class="flex items-center justify-center">
                    <div class="text-2xl font-bold mt-6">⇄</div>
                </div>
                <div>
                    <input type="time" id="utc-time" class="time-input border border-gray-300 rounded px-3 py-2 w-full" step="1">
                    <button id="utc-to-wib" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded w-full mt-1">
                        UTC → WIB
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="connection-status" class="connection-status connection-online">
        Koneksi: Online
    </div>

    <script>
        // Konfigurasi Firebase yang stabil
        const firebaseConfig = {
            apiKey: "AIzaSyDXjv3Yg8RJvxCrYYZvMjpEKSdxcshynTo",
            authDomain: "pangestu-timer.firebaseapp.com",
            databaseURL: "https://pangestu-timer-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pangestu-timer",
            storageBucket: "pangestu-timer.appspot.com",
            messagingSenderId: "423055274704",
            appId: "1:423055274704:web:3e9e438bc18439012364d5",
            measurementId: "G-0249BJFL8T"
        };

        // Inisialisasi Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Manajemen state
        const activeIntervals = {};
        const shownNotifications = new Set();
        const timerStates = {};
        let isProcessing = false;
        let isOnline = true;

        // Elemen status koneksi
        const connectionStatusEl = document.getElementById('connection-status');

        // Fungsi untuk menampilkan notifikasi
        function showNotification(title, message, icon = 'info', timer = 3000) {
            return Swal.fire({
                title: title,
                text: message,
                icon: icon,
                timer: timer,
                timerProgressBar: true,
                showConfirmButton: false,
                position: 'top-end',
                toast: true,
                width: '400px'
            });
        }

        // Format waktu selesai
        function formatFinishTime(date) {
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            const timeString = date.toLocaleTimeString('id-ID', options);
            
            const hours = date.getHours();
            let timeOfDay;
            
            if (hours >= 3 && hours < 11) timeOfDay = 'pagi';
            else if (hours >= 11 && hours < 15) timeOfDay = 'siang';
            else if (hours >= 15 && hours < 18) timeOfDay = 'sore';
            else timeOfDay = 'malam';
            
            return `${timeString} (${timeOfDay})`;
        }

        // Fungsi untuk memantau koneksi
        function setupConnectionMonitoring() {
            const connectedRef = database.ref(".info/connected");
            
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    // Koneksi pulih
                    isOnline = true;
                    connectionStatusEl.className = "connection-status connection-online";
                    connectionStatusEl.textContent = "Koneksi: Online";
                    
                    // Sembunyikan notifikasi setelah 3 detik
                    setTimeout(() => {
                        connectionStatusEl.style.display = 'none';
                    }, 3000);
                } else {
                    // Koneksi terputus
                    isOnline = false;
                    connectionStatusEl.className = "connection-status connection-offline";
                    connectionStatusEl.textContent = "Koneksi: Offline";
                    connectionStatusEl.style.display = 'block';
                    
                    showNotification('Peringatan', 'Koneksi server terputus', 'warning');
                }
            });

            // Tambahkan deteksi offline browser
            window.addEventListener('offline', () => {
                isOnline = false;
                connectionStatusEl.className = "connection-status connection-offline";
                connectionStatusEl.textContent = "Koneksi: Offline";
                connectionStatusEl.style.display = 'block';
            });

            window.addEventListener('online', () => {
                // Biarkan Firebase yang menentukan status sebenarnya
                database.ref('.info/connected').once('value');
            });
        }

        // Fungsi simpan ke Firebase dengan penanganan error
        async function saveTimerToFirebase(timerId, data) {
            if (isProcessing) return false;
            isProcessing = true;
            
            try {
                const ref = database.ref('timers/' + timerId);
                await ref.set(data);
                return true;
            } catch (error) {
                console.error("Firebase save error:", error);
                
                // Tampilkan notifikasi hanya untuk error selain timeout
                if (!error.message.includes('timeout')) {
                    showNotification('Error', 'Gagal menyimpan ke database', 'error');
                }
                
                return false;
            } finally {
                isProcessing = false;
            }
        }

        // Fungsi hapus dari Firebase dengan penanganan error
        async function deleteTimerFromFirebase(timerId) {
            try {
                await database.ref('timers/' + timerId).remove();
                return true;
            } catch (error) {
                console.error("Firebase delete error:", error);
                
                // Tampilkan notifikasi hanya untuk error selain timeout
                if (!error.message.includes('timeout')) {
                    showNotification('Error', 'Gagal menghapus timer', 'error');
                }
                
                return false;
            }
        }

        // Fungsi untuk menambahkan baris baru
        function addNewRow() {
            const tableBody = document.querySelector('#timer-table tbody');
            const rowCount = tableBody.querySelectorAll('tr').length + 1;
            const newRow = createNewRow(rowCount);
            tableBody.appendChild(newRow);
            addEventListenersToRow(newRow);
            
            saveTimerToFirebase(rowCount, {
                name: '',
                timer: '00:00:00',
                timerInputValue: '24:00:00',
                startDisabled: false,
                stopDisabled: true,
                timerVisible: false,
                isRunning: false,
                remainingSeconds: 0
            });
            
            showNotification('Berhasil', `Timer baru (#${rowCount}) telah ditambahkan`, 'success');
        }

        // ... (Fungsi-fungsi lainnya seperti createNewRow, startTimer, stopTimer, restartTimer tetap sama)
        // Pastikan semua fungsi yang berinteraksi dengan Firebase memiliki error handling

        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', function() {
            // Setup koneksi monitoring
            setupConnectionMonitoring();
            
            // Setup listener untuk data timer
            database.ref('timers').on('value', (snapshot) => {
                try {
                    const timers = snapshot.val() || {};
                    const tableBody = document.querySelector('#timer-table tbody');
                    tableBody.innerHTML = '';
                    
                    Object.entries(timers).forEach(([rowNumber, timerData]) => {
                        const newRow = createNewRow(rowNumber, timerData);
                        tableBody.appendChild(newRow);
                        addEventListenersToRow(newRow);
                        
                        // Inisialisasi timer yang sedang berjalan
                        if (timerData.isRunning) {
                            initializeRunningTimer(rowNumber, timerData, newRow);
                        }
                    });
                } catch (error) {
                    console.error("Error loading timers:", error);
                    showNotification('Error', 'Gagal memuat data timer', 'error');
                }
            });

            // Event listener untuk tombol-tombol
            document.getElementById('add-row-btn').addEventListener('click', addNewRow);
            document.getElementById('wib-to-utc').addEventListener('click', convertWIBtoUTC);
            document.getElementById('utc-to-wib').addEventListener('click', convertUTCtoWIB);
            
            // Inisialisasi waktu
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        // Fungsi untuk menginisialisasi timer yang sedang berjalan
        function initializeRunningTimer(rowNumber, timerData, rowElement) {
            const timerDisplay = rowElement.querySelector('.timer-display-box');
            const startButton = rowElement.querySelector('.start-btn');
            const stopButton = rowElement.querySelector('.stop-btn');
            const finishTimeBox = rowElement.querySelector('.finish-time-box');
            
            // Hitung sisa waktu
            const timeElapsed = timerData.timestamp ? 
                Math.floor((Date.now() - timerData.timestamp) / 1000) : 0;
            let remainingSeconds = Math.max(0, (timerData.remainingSeconds || 0) - timeElapsed);
            
            // Update state
            timerStates[rowNumber] = {
                isRunning: true,
                remainingSeconds: remainingSeconds,
                finishTime: timerData.finishTime ? new Date(timerData.finishTime) : null
            };
            
            // Update UI
            startButton.disabled = true;
            startButton.classList.add('bg-green-500', 'text-white');
            stopButton.disabled = false;
            
            if (timerData.finishTime) {
                finishTimeBox.textContent = formatFinishTime(new Date(timerData.finishTime));
                finishTimeBox.classList.remove('hidden');
            }
            
            // Fungsi update timer
            const updateTimer = async () => {
                if (remainingSeconds <= 0) {
                    clearInterval(activeIntervals[rowNumber]);
                    delete activeIntervals[rowNumber];
                    
                    timerStates[rowNumber].isRunning = false;
                    timerStates[rowNumber].remainingSeconds = 0;
                    timerStates[rowNumber].finishTime = null;
                    
                    await saveTimerToFirebase(rowNumber, {
                        name: timerData.name,
                        timer: '00:00:00',
                        timerInputValue: timerData.timerInputValue,
                        startDisabled: false,
                        stopDisabled: true,
                        timerVisible: false,
                        isRunning: false,
                        remainingSeconds: 0,
                        finishTime: null
                    });

                    finishTimeBox.classList.add('hidden');

                    if (!shownNotifications.has(rowNumber)) {
                        shownNotifications.add(rowNumber);
                        showNotification(
                            'Timer Selesai', 
                            `Timer #${rowNumber} (${timerData.name || 'Tanpa Nama'}) telah berhenti`, 
                            'info'
                        );
                    }
                    return;
                }
                
                timerStates[rowNumber].remainingSeconds = remainingSeconds - 1;
                const h = String(Math.floor(timerStates[rowNumber].remainingSeconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((timerStates[rowNumber].remainingSeconds % 3600) / 60)).padStart(2, '0');
                const s = String(timerStates[rowNumber].remainingSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${h}:${m}:${s}`;
                remainingSeconds--;
            };
            
            // Set tampilan awal
            const h = String(Math.floor(remainingSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((remainingSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(remainingSeconds % 60).padStart(2, '0');
            timerDisplay.textContent = `${h}:${m}:${s}`;
            timerDisplay.classList.remove('hidden');
            
            // Jalankan interval
            activeIntervals[rowNumber] = setInterval(updateTimer, 1000);
        }

        // Fungsi untuk mengupdate waktu dan tanggal
        function updateDateTime() {
            const now = new Date();
            
            const optionsWIB = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                timeZone: 'Asia/Jakarta',
                timeZoneName: 'short'
            };
            const formattedWIB = now.toLocaleDateString('id-ID', optionsWIB);
            
            const optionsUTC = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                timeZone: 'UTC',
                timeZoneName: 'short'
            };
            const formattedUTC = now.toLocaleDateString('id-ID', optionsUTC);
            
            document.getElementById('date-time').innerHTML = `
                ${formattedWIB} 
                <span class="time-separator">|</span> 
                ${formattedUTC}
            `;
        }

        // Fungsi konversi waktu
        function convertWIBtoUTC() {
            const wibTimeInput = document.getElementById('wib-time');
            const utcTimeInput = document.getElementById('utc-time');
            
            if (!wibTimeInput.value) {
                showNotification('Peringatan', 'Masukkan waktu WIB terlebih dahulu', 'warning');
                return;
            }
            
            const [hours, minutes, seconds] = wibTimeInput.value.split(':').map(Number);
            let utcHours = hours - 7;
            if (utcHours < 0) utcHours += 24;
            
            utcTimeInput.value = `${String(utcHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function convertUTCtoWIB() {
            const wibTimeInput = document.getElementById('wib-time');
            const utcTimeInput = document.getElementById('utc-time');
            
            if (!utcTimeInput.value) {
                showNotification('Peringatan', 'Masukkan waktu UTC terlebih dahulu', 'warning');
                return;
            }
            
            const [hours, minutes, seconds] = utcTimeInput.value.split(':').map(Number);
            let wibHours = hours + 7;
            if (wibHours >= 24) wibHours -= 24;
            
            wibTimeInput.value = `${String(wibHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
