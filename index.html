<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ðŸ”¥ Firebase SDK ðŸ”¥ -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
      import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAEvZsHU6gBfycu-uEt2sb42xzRvgR7_Ww",
        authDomain: "namas-timer.firebaseapp.com",
        databaseURL: "https://namas-timer-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "namas-timer",
        storageBucket: "namas-timer.appspot.com",
        messagingSenderId: "663877981459",
        appId: "1:663877981459:web:08bdcb0664652a82eaf6e6",
        measurementId: "G-Q6H1HTKHC6"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      
      window.firebaseDB = { db, ref, set, onValue, push, remove, update };
    </script>

    <style>
        .btn:active {
            transform: scale(0.95);
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            background: linear-gradient(270deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 1400% 1400%;
            animation: rainbow 60s ease infinite;
        }
        #alarm-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: red;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto w-full max-w-7xl">
        <div class="text-center mb-4">
            <div id="date-time" class="text-lg font-semibold"></div>
        </div>
        <table class="min-w-full divide-y divide-gray-200" id="timer-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Timer</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stop</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hapus</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
        <div class="mt-4 text-center">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Tambah Tabel Baru</button>
        </div>
    </div>
    <audio id="alarm-sound" src="./alarm.mp3" preload="auto"></audio>
    <div id="alarm-box">Alarm</div>

    <script>
        // ==================== [FUNGSI UTAMA] ====================
        
        function playAlarm() {
            const alarmSound = document.getElementById('alarm-sound');
            const alarmBox = document.getElementById('alarm-box');
            alarmSound.play();
            alarmBox.style.display = 'block';

            alarmBox.addEventListener('click', () => {
                alarmSound.pause();
                alarmSound.currentTime = 0;
                alarmBox.style.display = 'none';
            });
        }

        // ==================== [FIREBASE FUNCTIONS] ====================
        
        function saveTableState() {
            const rows = document.querySelectorAll('#timer-table tbody tr');
            const tableData = {};
            
            rows.forEach((row) => {
                const id = row.getAttribute('data-id');
                tableData[id] = {
                    name: row.querySelector('input[type="text"]').value,
                    timer: row.querySelector('.timer').textContent,
                    timerInput: row.querySelector('.timer-input').value,
                    startDisabled: row.querySelector('.start-btn').disabled,
                    stopDisabled: row.querySelector('.stop-btn').disabled
                };
            });

            firebaseDB.set(firebaseDB.ref(firebaseDB.db, 'timers'), tableData)
                .catch(error => {
                    console.error("Gagal menyimpan ke Firebase:", error);
                    localStorage.setItem('tableData', JSON.stringify(tableData));
                });
        }

        function loadTableState() {
            // Bersihkan cache lokal sebelum load
            localStorage.removeItem('tableData');
            
            const timerRef = firebaseDB.ref(firebaseDB.db, 'timers');
            
            firebaseDB.onValue(timerRef, (snapshot) => {
                const data = snapshot.val();
                const tableBody = document.querySelector('#timer-table tbody');
                tableBody.innerHTML = '';
                
                if (data) {
                    Object.keys(data).forEach((id) => {
                        const item = data[id];
                        const newRow = createTableRow(item, id);
                        tableBody.appendChild(newRow);
                        addEventListenersToRow(newRow);
                        
                        if (item.startDisabled && !item.stopDisabled) {
                            const timerInput = newRow.querySelector('.timer-input');
                            const timerElement = newRow.querySelector('.timer');
                            timerElement.textContent = timerInput.value;
                            timerInput.classList.add('hidden');
                            timerElement.classList.remove('hidden');
                        }
                    });
                    updateRowNumbers();
                }
            }, (error) => {
                console.error("Gagal memuat dari Firebase:", error);
                const localData = localStorage.getItem('tableData');
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    Object.keys(parsedData).forEach((id) => {
                        const newRow = createTableRow(parsedData[id], id);
                        document.querySelector('#timer-table tbody').appendChild(newRow);
                        addEventListenersToRow(newRow);
                    });
                    updateRowNumbers();
                }
            });
        }

        function createTableRow(item, id) {
            const row = document.createElement('tr');
            row.setAttribute('data-id', id);
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center"></td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="text" placeholder="Masukkan Nama" class="border border-gray-300 rounded px-2 py-1 w-full" value="${item.name || ''}">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="text" placeholder="HH:MM:SS" class="border border-gray-300 rounded px-2 py-1 w-full timer-input" value="${item.timerInput || item.timer || '24:00:00'}">
                    <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg ${item.startDisabled ? '' : 'hidden'}">${item.timer || '24:00:00'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full" ${item.startDisabled ? 'disabled' : ''}>Mulai</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" ${item.stopDisabled ? 'disabled' : ''}>Stop</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
                </td>
            `;
            return row;
        }

        // ==================== [TIMER FUNCTIONS] ====================
        
        function addEventListenersToRow(row) {
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const deleteButton = row.querySelector('.delete-btn');
            const timerElement = row.querySelector('.timer');
            const timerInput = row.querySelector('.timer-input');
            const nameInput = row.querySelector('input[type="text"]');
            const rowId = row.getAttribute('data-id');

            let interval;

            startButton.addEventListener('click', () => {
                let [hours, minutes, seconds] = timerInput.value.split(':').map(Number);
                let totalSeconds = hours * 3600 + minutes * 60 + seconds;

                timerElement.textContent = timerInput.value;
                timerInput.classList.add('hidden');
                timerElement.classList.remove('hidden');

                firebaseDB.update(firebaseDB.ref(firebaseDB.db, `timers/${rowId}`), {
                    timer: timerInput.value,
                    timerInput: timerInput.value,
                    startDisabled: true,
                    stopDisabled: false
                });

                interval = setInterval(() => {
                    if (totalSeconds <= 0) {
                        clearInterval(interval);
                        playAlarm();
                        firebaseDB.update(firebaseDB.ref(firebaseDB.db, `timers/${rowId}`), {
                            startDisabled: false,
                            stopDisabled: true
                        });
                        return;
                    }
                    totalSeconds--;
                    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                    const s = String(totalSeconds % 60).padStart(2, '0');
                    timerElement.textContent = `${h}:${m}:${s}`;
                    
                    firebaseDB.update(firebaseDB.ref(firebaseDB.db, `timers/${rowId}`), {
                        timer: timerElement.textContent
                    });
                }, 1000);

                startButton.disabled = true;
                stopButton.disabled = false;
            });

            stopButton.addEventListener('click', () => {
                clearInterval(interval);
                startButton.disabled = false;
                stopButton.disabled = true;

                firebaseDB.update(firebaseDB.ref(firebaseDB.db, `timers/${rowId}`), {
                    startDisabled: false,
                    stopDisabled: true
                });
            });

            deleteButton.addEventListener('click', () => {
                clearInterval(interval);
                firebaseDB.remove(firebaseDB.ref(firebaseDB.db, `timers/${rowId}`))
                    .then(() => {
                        row.remove();
                        updateRowNumbers();
                    })
                    .catch(error => {
                        console.error("Gagal menghapus:", error);
                        const localData = JSON.parse(localStorage.getItem('tableData') || {});
                        delete localData[rowId];
                        localStorage.setItem('tableData', JSON.stringify(localData));
                        row.remove();
                        updateRowNumbers();
                    });
            });

            nameInput.addEventListener('input', () => {
                firebaseDB.update(firebaseDB.ref(firebaseDB.db, `timers/${rowId}`), {
                    name: nameInput.value
                });
            });
        }

        function updateRowNumbers() {
            document.querySelectorAll('#timer-table tbody tr').forEach((row, index) => {
                row.querySelector('td').textContent = index + 1;
            });
        }

        // ==================== [INITIALIZATION] ====================
        
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Jakarta' };
            const formattedDateTime = now.toLocaleDateString('id-ID', options);
            document.getElementById('date-time').textContent = formattedDateTime;
        }

        document.getElementById('add-row-btn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Menambahkan...';
            
            const newId = Date.now().toString();
            const newTimerData = {
                name: '',
                timer: '24:00:00',
                timerInput: '24:00:00',
                startDisabled: false,
                stopDisabled: true
            };

            firebaseDB.set(firebaseDB.ref(firebaseDB.db, `timers/${newId}`), newTimerData)
                .then(() => {
                    console.log("Data berhasil ditambahkan");
                })
                .catch(error => {
                    console.error("Gagal menambah timer:", error);
                    const localData = JSON.parse(localStorage.getItem('tableData') || {});
                    localData[newId] = newTimerData;
                    localStorage.setItem('tableData', JSON.stringify(localData));
                    
                    const newRow = createTableRow(newTimerData, newId);
                    document.querySelector('#timer-table tbody').appendChild(newRow);
                    addEventListenersToRow(newRow);
                    updateRowNumbers();
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Tambah Tabel Baru';
                });
        });

        // ==================== [CLEAR FIREBASE CACHE ON LOAD] ====================
        window.addEventListener('load', () => {
            // Force clear Firebase cache
            if (window.firebaseDB && window.firebaseDB.db) {
                firebaseDB.ref(firebaseDB.db).off(); // Matikan semua listener sebelumnya
            }
            
            // Clear localStorage cache
            localStorage.removeItem('tableData');
            
            // Load data fresh
            loadTableState();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });
    </script>
</body>
</html>
