<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn:active {
            transform: scale(0.95);
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            background: linear-gradient(270deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 1400% 1400%;
            animation: rainbow 60s ease infinite;
        }
        #alarm-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: red;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
        #notification-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f0ad4e;
            color: white;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #eea236;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }
        #notification-text {
            margin-bottom: 10px;
        }
    </style>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics-compat.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAEvZsHU6gBfycu-uEt2sb42xzRvgR7_Ww",
            authDomain: "namas-timer.firebaseapp.com",
            projectId: "namas-timer",
            storageBucket: "namas-timer.firebasestorage.app",
            messagingSenderId: "663877981459",
            appId: "1:663877981459:web:08bdcb0664652a82eaf6e6",
            measurementId: "G-Q6H1HTKHC6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app); // Dapatkan instance database
        const timersRef = firebase.database().ref('timers'); // Referensi ke node 'timers'
    </script>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto w-full max-w-7xl">
        <div class="text-center mb-4">
            <div id="date-time" class="text-lg font-semibold"></div>
        </div>
        <table class="min-w-full divide-y divide-gray-200" id="timer-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Timer</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stop</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hapus</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
        <div class="mt-4 text-center">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Tambah Tabel Baru</button>
        </div>
    </div>
    <audio id="alarm-sound" src="./alarm.mp3" preload="auto"></audio>
    <div id="alarm-box">Alarm</div>

    <div id="notification-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f0ad4e; color: white; padding: 20px; border-radius: 5px; border: 1px solid #eea236; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; display: none;">
        <p id="notification-text" style="margin-bottom: 10px;"></p>
        <button onclick="hideNotification()" style="background-color: #d9534f; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;">Tutup</button>
    </div>

    <script>
        // Fungsi untuk memainkan suara alarm
        function playAlarm() {
            const alarmSound = document.getElementById('alarm-sound');
            const alarmBox = document.getElementById('alarm-box');
            alarmSound.play();
            alarmBox.style.display = 'block';

            alarmBox.addEventListener('click', () => {
                alarmSound.pause();
                alarmSound.currentTime = 0;
                alarmBox.style.display = 'none';
            });
        }

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message) {
            const notificationBox = document.getElementById('notification-box');
            const notificationText = document.getElementById('notification-text');
            notificationText.textContent = message;
            notificationBox.style.display = 'block';
        }

        // Fungsi untuk menyembunyikan notifikasi
        function hideNotification() {
            const notificationBox = document.getElementById('notification-box');
            notificationBox.style.display = 'none';
        }

        // Fungsi untuk menambahkan event listener ke setiap baris timer
        function addEventListenersToRow(row) {
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const deleteButton = row.querySelector('.delete-btn');
            const timerElement = row.querySelector('.timer');
            const timerInput = row.querySelector('.timer-input');
            const nameInput = row.querySelector('input[type="text"]');
            const rowNumber = row.querySelector('td').textContent;
            let timerId; // Untuk menyimpan ID Firebase dari timer ini
            let interval;

            startButton.addEventListener('click', () => {
                let [hours, minutes, seconds] = timerInput.value.split(':').map(Number);
                let totalSeconds = hours * 3600 + minutes * 60 + seconds;

                timerElement.textContent = timerInput.value;
                timerInput.classList.add('hidden');
                timerElement.classList.remove('hidden');

                const timerData = {
                    name: nameInput.value,
                    duration: timerInput.value,
                    remaining: totalSeconds,
                    isRunning: true // Tambahkan status isRunning
                };

                // Simpan data timer ke Firebase dan dapatkan ID-nya
                const newTimerRef = timersRef.push(timerData);
                timerId = newTimerRef.key; // Simpan ID Firebase

                interval = setInterval(() => {
                    if (totalSeconds <= 0) {
                        clearInterval(interval);
                        playAlarm();
                        showNotification(`Timer untuk "${nameInput.value}" telah habis!`);
                        // Perbarui status di Firebase menjadi selesai
                        if (timerId) {
                            timersRef.child(timerId).update({ isRunning: false, remaining: 0 });
                        }
                        return;
                    }
                    totalSeconds--;
                    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                    const s = String(totalSeconds % 60).padStart(2, '0');
                    timerElement.textContent = `<span class="math-inline">\{h\}\:</span>{m}:${s}`;
                    // Perbarui nilai di Firebase
                    if (timerId) {
                        timersRef.child(timerId).update({ remaining: totalSeconds });
                    }
                }, 1000);

                startButton.disabled = true;
                startButton.classList.add('bg-green-500', 'text-white');
                stopButton.disabled = false;

                stopButton.addEventListener('click', () => {
                    clearInterval(interval);
                    startButton.disabled = false;
                    startButton.classList.remove('bg-green-500', 'text-white');
                    stopButton.disabled = true;
                    if (timerId) {
                        timersRef.child(timerId).update({ isRunning: false }); // Tandai sebagai tidak berjalan
                    }
                });
            });

            deleteButton.addEventListener('click', () => {
                const timerIdToDelete = row.getAttribute('data-timer-id'); // Dapatkan ID Firebase dari atribut
                if (timerIdToDelete) {
                    timersRef.child(timerIdToDelete).remove() // Hapus data dari Firebase
                        .then(() => {
                            console.log('Timer dihapus dari Firebase');
                            row.remove();
                            updateRowNumbers();
                        })
                        .catch((error) => {
                            console.error('Gagal menghapus timer dari Firebase:', error);
                        });
                } else {
                    row.remove(); // Jika belum disimpan di Firebase, hapus dari tampilan saja
                    updateRowNumbers();
                }
            });

            nameInput.addEventListener('input', () => {
                // Jika timer sudah disimpan di Firebase, perbarui namanya
                if (timerId) {
                    timersRef.child(timerId).update({ name: nameInput.value });
                }
            });
        }

        // Fungsi untuk memperbarui nomor urut baris
        function updateRowNumbers() {
            document.querySelectorAll('#timer-table tbody tr').forEach((row, index) => {
                row.querySelector('td').textContent = index + 1;
            });
        }

        // Fungsi untuk memuat data timer dari Firebase saat halaman dimuat
        function loadTimersFromFirebase() {
            timersRef.on('child_added', (snapshot) => {
                const timerData = snapshot.val();
                const timerId = snapshot.key; // ID unik dari Firebase

                if (timerData) {
                    const tableBody = document.querySelector('#timer-table tbody');
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-timer-id', timerId); // Tambahkan ID Firebase ke atribut baris
                    const rowCount = tableBody.rows.length + 1; // Untuk nomor urut tampilan

                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center"><span class="math-inline">\{rowCount\}</td\>
<td class\="px\-6 py\-4 whitespace\-nowrap text\-center"\>
<input type\="text" placeholder\="Masukkan Nama" class\="border border\-gray\-300 rounded px\-2 py\-1 w\-full" value\="</span>{timerData.name || ''}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <input type="text" placeholder="HH:MM:SS" class="border border-gray-300 rounded px-2 py-1 w-full timer-input" value="${timerData.duration || '00:00:00'}">
                            <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg <span class="math-inline">\{timerData\.isRunning ? '' \: 'hidden'\}"\></span>{formatTime(timerData.remaining || 0)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full" ${timerData.isRunning ? 'disabled' : ''}>Mulai</button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" ${!timerData.isRunning ? 'disabled' : ''}>Stop</button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
                        </td>
                    `;
                    tableBody.appendChild(newRow);
                    addEventListenersToRow(newRow);

                    // Jika timer sedang berjalan saat dimuat, mulai interval
                    if (timerData.isRunning && timerData.remaining > 0) {
                        startExistingTimer(newRow, timerData.remaining, timerId);
                    }
                }
            });
        }

        // Fungsi untuk memformat detik menjadi HH:MM:SS
        function formatTime(totalSeconds) {
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(totalSeconds % 60).padStart(2, '0');
            return `<span class="math-inline">\{h\}\:</span>{m}:${s}`;
        }

        // Fungsi untuk memulai timer yang sudah ada saat halaman dimuat
        function startExistingTimer(row, remainingTime, timerId) {
            const timerElement = row.querySelector('.timer');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const nameInput = row.querySelector('input[type="text"]');

            let totalSeconds = remainingTime;
            let interval = setInterval(() => { // Tambahkan deklarasi interval di sini
            if (totalSeconds <= 0) {
                clearInterval(interval);
                playAlarm();
                showNotification(`Timer untuk "${nameInput.value}" telah habis!`);
                timersRef.child(timerId).update({ isRunning: false, remaining: 0 });
                return;
            }
            totalSeconds--;
            timerElement.textContent = formatTime(totalSeconds);
            timersRef.child(timerId).update({ remaining: totalSeconds });
        }, 1000);

        startButton.disabled = true;
        startButton.classList.add('bg-green-500', 'text-white');
        stopButton.disabled = false;

        stopButton.addEventListener('click', () => {
            clearInterval(interval);
            startButton.disabled = false;
            startButton.classList.remove('bg-green-500', 'text-white');
            stopButton.disabled = true;
            timersRef.child(timerId).update({ isRunning: false });
        });
    }
}

// Fungsi untuk memuat data timer dari Firebase saat halaman dimuat (lanjutan)
function loadTimersFromFirebase() {
    timersRef.on('child_added', (snapshot) => {
        const timerData = snapshot.val();
        const timerId = snapshot.key; // ID unik dari Firebase

        if (timerData) {
            const tableBody = document.querySelector('#timer-table tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-timer-id', timerId); // Tambahkan ID Firebase ke atribut baris
            const rowCount = tableBody.rows.length + 1; // Untuk nomor urut tampilan

            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${rowCount}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="text" placeholder="Masukkan Nama" class="border border-gray-300 rounded px-2 py-1 w-full" value="${timerData.name || ''}">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="text" placeholder="HH:MM:SS" class="border border-gray-300 rounded px-2 py-1 w-full timer-input" value="${timerData.duration || '00:00:00'}">
                    <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg ${timerData.isRunning ? '' : 'hidden'}">${formatTime(timerData.remaining || 0)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full" ${timerData.isRunning ? 'disabled' : ''}>Mulai</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" ${!timerData.isRunning ? 'disabled' : ''}>Stop</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
                </td>
            `;
            tableBody.appendChild(newRow);
            addEventListenersToRow(newRow);

            // Jika timer sedang berjalan saat dimuat, mulai interval
            if (timerData.isRunning && timerData.remaining > 0) {
                startExistingTimer(newRow, timerData.remaining, timerId);
            }
        }
    });
}

// Fungsi untuk memformat detik menjadi HH:MM:SS
function formatTime(totalSeconds) {
    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const s = String(totalSeconds % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
}

// Fungsi untuk memulai timer yang sudah ada saat halaman dimuat
function startExistingTimer(row, remainingTime, timerId) {
    const timerElement = row.querySelector('.timer');
    const startButton = row.querySelector('.start-btn');
    const stopButton = row.querySelector('.stop-btn');
    const nameInput = row.querySelector('input[type="text"]');

    let totalSeconds = remainingTime;
    let interval = setInterval(() => {
        if (totalSeconds <= 0) {
            clearInterval(interval);
            playAlarm();
            showNotification(`Timer untuk "${nameInput.value}" telah habis!`);
            timersRef.child(timerId).update({ isRunning: false, remaining: 0 });
            return;
        }
        totalSeconds--;
        timerElement.textContent = formatTime(totalSeconds);
        timersRef.child(timerId).update({ remaining: totalSeconds });
    }, 1000);

    startButton.disabled = true;
    startButton.classList.add('bg-green-500', 'text-white');
    stopButton.disabled = false;
}

// Fungsi untuk memperbarui tanggal dan waktu
function updateDateTime() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Jakarta' };
    const formattedDateTime = now.toLocaleDateString('id-ID', options);
    document.getElementById('date-time').textContent = formattedDateTime;
}

// Event listener untuk tombol "Tambah Tabel Baru"
document.getElementById('add-row-btn').addEventListener('click', () => {
    const tableBody = document.querySelector('#timer-table tbody');
    const rowCount = tableBody.rows.length + 1;
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${rowCount}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <input type="text" placeholder="Masukkan Nama" class="border border-gray-300 rounded px-2 py-1 w-full">
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <input type="text" placeholder="HH:MM:SS" class="border border-gray-300 rounded px-2 py-1 w-full timer-input" value="00:00:00">
            <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg hidden">00:00:00</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full">Mulai</button>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" disabled>Stop</button>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
        </td>
    `;
    tableBody.appendChild(newRow);
    addEventListenersToRow(newRow);
});

// Panggil fungsi untuk memuat data dari Firebase saat halaman dimuat
window.addEventListener('load', () => {
    updateDateTime();
    setInterval(updateDateTime, 1000);
    loadTimersFromFirebase();
});

// Event listener untuk menangani klik pada tombol "Mulai" di baris baru (jika ada)
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('start-btn')) {
        const row = event.target.closest('tr');
        const timerInput = row.querySelector('.timer-input');
        const timerElement = row.querySelector('.timer');
        timerElement.textContent = timerInput.value;
        timerInput.classList.add('hidden');
        timerElement.classList.remove('hidden');
    }
});
    </script>
</body>
</html>
