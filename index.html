<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table with Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        .btn:active {
            transform: scale(0.95);
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        
        .timer-display-box {
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            display: inline-block;
            min-width: 100px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            background-color: #ecfdf5;
            color: #047857;
        }
        
        .finish-time-box {
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            display: inline-block;
            min-width: 150px;
            text-align: center;
            font-weight: bold;
            background-color: #ecfdf5;
            color: #047857;
        }
        
        .name-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            min-width: 150px;
            background-color: white;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-green-500 to-green-700">
    <div class="main-container bg-white rounded-lg shadow-lg p-4 mx-auto my-4 w-full max-w-7xl">
        <div class="text-center mb-4">
            <div id="date-time" class="text-lg font-semibold"></div>
        </div>
        
        <div class="table-container overflow-x-auto mb-4 max-h-[60vh]">
            <table class="min-w-full divide-y divide-gray-200" id="timer-table">
                <thead class="table-header bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-center">No</th>
                        <th class="px-4 py-3 text-center">Nama</th>
                        <th class="px-4 py-3 text-center">Set Timer</th>
                        <th class="px-4 py-3 text-center">Timer Berjalan</th>
                        <th class="px-4 py-3 text-center">Selesai Pada</th>
                        <th class="px-4 py-3 text-center">Mulai</th>
                        <th class="px-4 py-3 text-center">Stop</th>
                        <th class="px-4 py-3 text-center">Restart</th>
                        <th class="px-4 py-3 text-center">Hapus</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be added dynamically -->
                </tbody>
            </table>
        </div>

        <div class="text-center mb-4">
            <button id="add-row-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                Tambah Tabel Baru
            </button>
        </div>

        <div class="converter-container bg-white bg-opacity-90 rounded-lg p-4 mt-4 shadow">
            <div class="converter-title text-lg font-bold mb-2">Konverter Waktu WIB ⇄ UTC</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <input type="time" id="wib-time" class="time-input border border-gray-300 rounded px-3 py-2 w-full" step="1">
                    <button id="wib-to-utc" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded w-full mt-1">
                        WIB → UTC
                    </button>
                </div>
                <div class="flex items-center justify-center">
                    <div class="text-2xl font-bold mt-6">⇄</div>
                </div>
                <div>
                    <input type="time" id="utc-time" class="time-input border border-gray-300 rounded px-3 py-2 w-full" step="1">
                    <button id="utc-to-wib" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded w-full mt-1">
                        UTC → WIB
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDXjv3Yg8RJvxCrYYZvMjpEKSdxcshynTo",
            authDomain: "pangestu-timer.firebaseapp.com",
            databaseURL: "https://pangestu-timer-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pangestu-timer",
            storageBucket: "pangestu-timer.appspot.com",
            messagingSenderId: "423055274704",
            appId: "1:423055274704:web:3e9e438bc18439012364d5",
            measurementId: "G-0249BJFL8T"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // State management
        const activeIntervals = {};
        const shownNotifications = new Set();
        const timerStates = {};
        let isProcessing = false;

        // Utility functions
        function showNotification(title, message, icon = 'info', timer = 3000) {
            return Swal.fire({
                title: title,
                text: message,
                icon: icon,
                timer: timer,
                timerProgressBar: true,
                showConfirmButton: false,
                position: 'top-end',
                toast: true,
                width: '400px'
            });
        }

        function formatFinishTime(date) {
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            const timeString = date.toLocaleTimeString('id-ID', options);
            
            const hours = date.getHours();
            let timeOfDay;
            
            if (hours >= 3 && hours < 11) timeOfDay = 'pagi';
            else if (hours >= 11 && hours < 15) timeOfDay = 'siang';
            else if (hours >= 15 && hours < 18) timeOfDay = 'sore';
            else timeOfDay = 'malam';
            
            return `${timeString} (${timeOfDay})`;
        }

        async function saveTimerToFirebase(timerId, data) {
            if (isProcessing) return false;
            isProcessing = true;
            
            try {
                const ref = database.ref('timers/' + timerId);
                await ref.transaction((currentData) => {
                    return currentData ? {...currentData, ...data} : data;
                });
                return true;
            } catch (error) {
                console.error("Firebase save error:", error);
                showNotification('Error', 'Gagal menyimpan ke database', 'error');
                return false;
            } finally {
                isProcessing = false;
            }
        }

        async function deleteTimerFromFirebase(timerId) {
            try {
                await database.ref('timers/' + timerId).remove();
                return true;
            } catch (error) {
                console.error("Firebase delete error:", error);
                showNotification('Error', 'Gagal menghapus timer', 'error');
                return false;
            }
        }

        function setRowLoadingState(rowNumber, isLoading) {
            const row = document.querySelector(`#timer-table tr:nth-child(${rowNumber})`);
            if (row) {
                const buttons = row.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.disabled = isLoading;
                });
                row.classList.toggle('loading', isLoading);
            }
        }

        // Timer functions
        function createNewRow(rowNumber, timerData = null) {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td class="px-4 py-3 text-center">${rowNumber}</td>
                <td class="px-4 py-3 text-center">
                    <input type="text" placeholder="Masukkan Nama" class="name-input" value="${timerData?.name || ''}">
                </td>
                <td class="px-4 py-3 text-center">
                    <input type="time" step="1" class="timer-input border rounded px-2 py-1 w-full" value="${timerData?.timerInputValue || '24:00:00'}">
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="timer-display-box ${timerData?.timerVisible ? '' : 'hidden'}">
                        ${timerData?.timer || '00:00:00'}
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="finish-time-box ${timerData?.finishTime ? '' : 'hidden'}">
                        ${timerData?.finishTime ? formatFinishTime(new Date(timerData.finishTime)) : '-'}
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <button class="start-btn bg-white border rounded px-2 py-1 w-full ${timerData?.startDisabled ? 'bg-green-500 text-white' : ''}" ${timerData?.startDisabled ? 'disabled' : ''}>
                        Mulai
                    </button>
                </td>
                <td class="px-4 py-3 text-center">
                    <button class="stop-btn bg-gray-200 border rounded px-2 py-1 w-full" ${timerData?.stopDisabled ? 'disabled' : ''}>
                        Stop
                    </button>
                </td>
                <td class="px-4 py-3 text-center">
                    <button class="restart-btn bg-yellow-500 text-white border rounded px-2 py-1 w-full">
                        Restart
                    </button>
                </td>
                <td class="px-4 py-3 text-center">
                    <button class="delete-btn bg-red-500 text-white border rounded px-2 py-1 w-full">
                        Hapus
                    </button>
                </td>
            `;
            return newRow;
        }

        async function startTimer(rowNumber) {
            if (activeIntervals[rowNumber]) {
                clearInterval(activeIntervals[rowNumber]);
                delete activeIntervals[rowNumber];
            }

            setRowLoadingState(rowNumber, true);
            
            const row = document.querySelector(`#timer-table tr:nth-child(${rowNumber})`);
            if (!row) return;

            const timerInput = row.querySelector('.timer-input');
            const timerDisplay = row.querySelector('.timer-display-box');
            const finishTimeBox = row.querySelector('.finish-time-box');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const nameInput = row.querySelector('.name-input');

            try {
                const timeValue = timerInput.value;
                if (!timeValue) {
                    showNotification('Peringatan', 'Silakan set waktu terlebih dahulu', 'warning');
                    return;
                }

                const [hoursStr, minutesStr, secondsStr] = timeValue.split(':');
                const hours = parseInt(hoursStr) || 0;
                const minutes = parseInt(minutesStr) || 0;
                const seconds = parseInt(secondsStr) || 0;
                
                let totalSeconds = hours * 3600 + minutes * 60 + seconds;

                if (totalSeconds <= 0) {
                    showNotification('Peringatan', 'Masukkan waktu yang valid (HH:MM:SS)', 'warning');
                    return;
                }

                const now = new Date();
                const finishTime = new Date(now.getTime() + totalSeconds * 1000);

                timerStates[rowNumber] = {
                    isRunning: true,
                    remainingSeconds: totalSeconds,
                    finishTime: finishTime
                };

                finishTimeBox.textContent = formatFinishTime(finishTime);
                finishTimeBox.classList.remove('hidden');

                const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const s = String(totalSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${h}:${m}:${s}`;
                timerDisplay.classList.remove('hidden');

                const success = await saveTimerToFirebase(rowNumber, {
                    name: nameInput.value,
                    timer: timerDisplay.textContent,
                    timerInputValue: timerInput.value,
                    startDisabled: true,
                    stopDisabled: false,
                    timerVisible: true,
                    remainingSeconds: totalSeconds,
                    isRunning: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    finishTime: finishTime.getTime()
                });

                if (!success) return;

                activeIntervals[rowNumber] = setInterval(async () => {
                    try {
                        totalSeconds = timerStates[rowNumber].remainingSeconds;
                        
                        if (totalSeconds <= 0) {
                            clearInterval(activeIntervals[rowNumber]);
                            delete activeIntervals[rowNumber];
                            
                            timerStates[rowNumber].isRunning = false;
                            timerStates[rowNumber].remainingSeconds = 0;
                            timerStates[rowNumber].finishTime = null;

                            await saveTimerToFirebase(rowNumber, {
                                name: nameInput.value,
                                timer: '00:00:00',
                                timerInputValue: timerInput.value,
                                startDisabled: false,
                                stopDisabled: true,
                                timerVisible: false,
                                isRunning: false,
                                remainingSeconds: 0,
                                finishTime: null
                            });

                            finishTimeBox.classList.add('hidden');

                            if (!shownNotifications.has(rowNumber)) {
                                shownNotifications.add(rowNumber);
                                showNotification(
                                    'Timer Selesai', 
                                    `Timer #${rowNumber} (${nameInput.value || 'Tanpa Nama'}) telah berhenti`, 
                                    'info'
                                );
                            }
                            return;
                        }
                        
                        timerStates[rowNumber].remainingSeconds = totalSeconds - 1;
                        const h = String(Math.floor(timerStates[rowNumber].remainingSeconds / 3600)).padStart(2, '0');
                        const m = String(Math.floor((timerStates[rowNumber].remainingSeconds % 3600) / 60)).padStart(2, '0');
                        const s = String(timerStates[rowNumber].remainingSeconds % 60).padStart(2, '0');
                        timerDisplay.textContent = `${h}:${m}:${s}`;
                        
                        await saveTimerToFirebase(rowNumber, {
                            name: nameInput.value,
                            timer: timerDisplay.textContent,
                            timerInputValue: timerInput.value,
                            startDisabled: true,
                            stopDisabled: false,
                            timerVisible: true,
                            remainingSeconds: timerStates[rowNumber].remainingSeconds,
                            isRunning: true,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            finishTime: finishTime.getTime()
                        });
                    } catch (error) {
                        console.error("Timer interval error:", error);
                        clearInterval(activeIntervals[rowNumber]);
                        delete activeIntervals[rowNumber];
                    }
                }, 1000);

                startButton.disabled = true;
                startButton.classList.add('bg-green-500', 'text-white');
                stopButton.disabled = false;
                
                showNotification(
                    'Timer Dimulai', 
                    `Timer #${rowNumber} (${nameInput.value || 'Tanpa Nama'}) telah dimulai`,
                    'success'
                );
            } catch (error) {
                console.error("Start timer error:", error);
                showNotification('Error', 'Gagal memulai timer', 'error');
            } finally {
                setRowLoadingState(rowNumber, false);
            }
        }

        async function stopTimer(rowNumber) {
            if (activeIntervals[rowNumber]) {
                clearInterval(activeIntervals[rowNumber]);
                delete activeIntervals[rowNumber];
            }
            
            setRowLoadingState(rowNumber, true);
            
            const row = document.querySelector(`#timer-table tr:nth-child(${rowNumber})`);
            if (!row) return;

            const timerDisplay = row.querySelector('.timer-display-box');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const nameInput = row.querySelector('.name-input');
            const timerInput = row.querySelector('.timer-input');

            try {
                timerStates[rowNumber].isRunning = false;
                
                const success = await saveTimerToFirebase(rowNumber, {
                    name: nameInput.value,
                    timer: timerDisplay.textContent,
                    timerInputValue: timerInput.value,
                    startDisabled: false,
                    stopDisabled: true,
                    timerVisible: true,
                    remainingSeconds: timerStates[rowNumber].remainingSeconds,
                    isRunning: false,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    finishTime: timerStates[rowNumber].finishTime ? timerStates[rowNumber].finishTime.getTime() : null
                });

                if (!success) return;

                startButton.disabled = false;
                startButton.classList.remove('bg-green-500', 'text-white');
                stopButton.disabled = true;

                showNotification(
                    'Timer Dihentikan', 
                    `Timer #${rowNumber} (${nameInput.value || 'Tanpa Nama'}) dihentikan manual`, 
                    'warning'
                );
            } catch (error) {
                console.error("Stop timer error:", error);
                showNotification('Error', 'Gagal menghentikan timer', 'error');
            } finally {
                setRowLoadingState(rowNumber, false);
            }
        }

        async function restartTimer(rowNumber) {
            if (activeIntervals[rowNumber]) {
                clearInterval(activeIntervals[rowNumber]);
                delete activeIntervals[rowNumber];
            }
            
            setRowLoadingState(rowNumber, true);
            
            const row = document.querySelector(`#timer-table tr:nth-child(${rowNumber})`);
            if (!row) return;

            const timerDisplay = row.querySelector('.timer-display-box');
            const timerInput = row.querySelector('.timer-input');
            const finishTimeBox = row.querySelector('.finish-time-box');
            const nameInput = row.querySelector('.name-input');
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');

            try {
                const timeValue = timerInput.value;
                if (!timeValue) {
                    showNotification('Peringatan', 'Silakan set waktu terlebih dahulu', 'warning');
                    return;
                }

                const [hoursStr, minutesStr, secondsStr] = timeValue.split(':');
                const hours = parseInt(hoursStr) || 0;
                const minutes = parseInt(minutesStr) || 0;
                const seconds = parseInt(secondsStr) || 0;
                
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;

                if (totalSeconds <= 0) {
                    showNotification('Peringatan', 'Masukkan waktu yang valid (HH:MM:SS)', 'warning');
                    return;
                }

                timerStates[rowNumber] = {
                    isRunning: false,
                    remainingSeconds: totalSeconds,
                    finishTime: null
                };
                
                const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const s = String(totalSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${h}:${m}:${s}`;
                timerDisplay.classList.remove('hidden');
                finishTimeBox.classList.add('hidden');

                const success = await saveTimerToFirebase(rowNumber, {
                    name: nameInput.value,
                    timer: timerDisplay.textContent,
                    timerInputValue: timerInput.value,
                    startDisabled: false,
                    stopDisabled: true,
                    timerVisible: true,
                    remainingSeconds: totalSeconds,
                    isRunning: false,
                    finishTime: null
                });

                if (!success) return;

                startButton.disabled = false;
                startButton.classList.remove('bg-green-500', 'text-white');
                stopButton.disabled = true;

                showNotification(
                    'Timer Diulang', 
                    `Timer #${rowNumber} (${nameInput.value || 'Tanpa Nama'}) telah diulang ke waktu awal`,
                    'success'
                );
            } catch (error) {
                console.error("Restart timer error:", error);
                showNotification('Error', 'Gagal mengulang timer', 'error');
            } finally {
                setRowLoadingState(rowNumber, false);
            }
        }

        function addEventListenersToRow(row) {
            const rowNumber = row.querySelector('td').textContent;
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const restartButton = row.querySelector('.restart-btn');
            const deleteButton = row.querySelector('.delete-btn');
            const nameInput = row.querySelector('.name-input');
            const timerInput = row.querySelector('.timer-input');

            // Initialize timer state if not exists
            if (!timerStates[rowNumber]) {
                timerStates[rowNumber] = {
                    isRunning: false,
                    remainingSeconds: 0,
                    finishTime: null
                };
            }

            startButton.addEventListener('click', async () => {
                await startTimer(rowNumber);
            });

            stopButton.addEventListener('click', async () => {
                await stopTimer(rowNumber);
            });

            restartButton.addEventListener('click', async () => {
                await restartTimer(rowNumber);
            });

            deleteButton.addEventListener('click', async () => {
                const { isConfirmed } = await Swal.fire({
                    title: 'Konfirmasi Hapus',
                    html: `Yakin ingin menghapus <b>Timer #${rowNumber}</b> (${nameInput.value || 'Tanpa Nama'})?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal',
                    width: '500px'
                });

                if (isConfirmed) {
                    setRowLoadingState(rowNumber, true);
                    
                    if (activeIntervals[rowNumber]) {
                        clearInterval(activeIntervals[rowNumber]);
                        delete activeIntervals[rowNumber];
                    }
                    
                    const success = await deleteTimerFromFirebase(rowNumber);
                    if (success) {
                        delete timerStates[rowNumber];
                        shownNotifications.delete(rowNumber);
                        row.remove();
                        updateRowNumbers();
                        
                        showNotification(
                            'Berhasil', 
                            `Timer #${rowNumber} telah dihapus`, 
                            'success'
                        );
                    }
                    setRowLoadingState(rowNumber, false);
                }
            });

            nameInput.addEventListener('input', async () => {
                const timerDisplay = row.querySelector('.timer-display-box');
                await saveTimerToFirebase(rowNumber, {
                    name: nameInput.value,
                    timer: timerDisplay.textContent,
                    timerInputValue: timerInput.value,
                    startDisabled: startButton.disabled,
                    stopDisabled: stopButton.disabled,
                    timerVisible: !timerDisplay.classList.contains('hidden'),
                    isRunning: timerStates[rowNumber].isRunning,
                    remainingSeconds: timerStates[rowNumber].remainingSeconds,
                    finishTime: timerStates[rowNumber].finishTime ? timerStates[rowNumber].finishTime.getTime() : null
                });
            });

            timerInput.addEventListener('change', async () => {
                const timerDisplay = row.querySelector('.timer-display-box');
                await saveTimerToFirebase(rowNumber, {
                    name: nameInput.value,
                    timer: timerDisplay.textContent,
                    timerInputValue: timerInput.value,
                    startDisabled: startButton.disabled,
                    stopDisabled: stopButton.disabled,
                    timerVisible: !timerDisplay.classList.contains('hidden'),
                    isRunning: timerStates[rowNumber].isRunning,
                    remainingSeconds: timerStates[rowNumber].remainingSeconds,
                    finishTime: timerStates[rowNumber].finishTime ? timerStates[rowNumber].finishTime.getTime() : null
                });
            });
        }

        function updateRowNumbers() {
            document.querySelectorAll('#timer-table tbody tr').forEach((row, index) => {
                const newRowNumber = index + 1;
                const oldRowNumber = row.querySelector('td').textContent;
                row.querySelector('td').textContent = newRowNumber;
                
                if (activeIntervals[oldRowNumber]) {
                    activeIntervals[newRowNumber] = activeIntervals[oldRowNumber];
                    delete activeIntervals[oldRowNumber];
                }
                
                if (timerStates[oldRowNumber]) {
                    timerStates[newRowNumber] = timerStates[oldRowNumber];
                    delete timerStates[oldRowNumber];
                }
                
                if (shownNotifications.has(oldRowNumber)) {
                    shownNotifications.delete(oldRowNumber);
                    shownNotifications.add(newRowNumber);
                }
            });
        }

        function updateDateTime() {
            const now = new Date();
            
            const optionsWIB = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                timeZone: 'Asia/Jakarta',
                timeZoneName: 'short'
            };
            const formattedWIB = now.toLocaleDateString('id-ID', optionsWIB);
            
            const optionsUTC = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                timeZone: 'UTC',
                timeZoneName: 'short'
            };
            const formattedUTC = now.toLocaleDateString('id-ID', optionsUTC);
            
            document.getElementById('date-time').innerHTML = `
                ${formattedWIB} 
                <span class="time-separator">|</span> 
                ${formattedUTC}
            `;
        }

        function convertWIBtoUTC() {
            const wibTimeInput = document.getElementById('wib-time');
            const utcTimeInput = document.getElementById('utc-time');
            
            if (!wibTimeInput.value) {
                showNotification('Peringatan', 'Masukkan waktu WIB terlebih dahulu', 'warning');
                return;
            }
            
            const [hours, minutes, seconds] = wibTimeInput.value.split(':').map(Number);
            let utcHours = hours - 7;
            if (utcHours < 0) utcHours += 24;
            
            utcTimeInput.value = `${String(utcHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function convertUTCtoWIB() {
            const wibTimeInput = document.getElementById('wib-time');
            const utcTimeInput = document.getElementById('utc-time');
            
            if (!utcTimeInput.value) {
                showNotification('Peringatan', 'Masukkan waktu UTC terlebih dahulu', 'warning');
                return;
            }
            
            const [hours, minutes, seconds] = utcTimeInput.value.split(':').map(Number);
            let wibHours = hours + 7;
            if (wibHours >= 24) wibHours -= 24;
            
            wibTimeInput.value = `${String(wibHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function addNewRow() {
            const tableBody = document.querySelector('#timer-table tbody');
            const rowCount = tableBody.querySelectorAll('tr').length + 1;
            const newRow = createNewRow(rowCount);
            tableBody.appendChild(newRow);
            addEventListenersToRow(newRow);
            
            saveTimerToFirebase(rowCount, {
                name: '',
                timer: '00:00:00',
                timerInputValue: '24:00:00',
                startDisabled: false,
                stopDisabled: true,
                timerVisible: false,
                isRunning: false,
                remainingSeconds: 0
            });
            
            showNotification('Berhasil', `Timer baru (#${rowCount}) telah ditambahkan`, 'success');
        }

        function checkFirebaseConnection() {
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    console.log("Connected to Firebase");
                } else {
                    console.log("Disconnected from Firebase");
                    showNotification('Peringatan', 'Koneksi ke server terputus', 'warning');
                }
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkFirebaseConnection();
            
            listenForTimerChanges((timers) => {
                try {
                    const tableBody = document.querySelector('#timer-table tbody');
                    tableBody.innerHTML = '';
                    
                    if (timers) {
                        Object.entries(timers).forEach(([rowNumber, timerData]) => {
                            const newRow = createNewRow(rowNumber, timerData);
                            tableBody.appendChild(newRow);
                            addEventListenersToRow(newRow);
                            
                            if (timerData.isRunning) {
                                const timerDisplay = newRow.querySelector('.timer-display-box');
                                const startButton = newRow.querySelector('.start-btn');
                                const stopButton = newRow.querySelector('.stop-btn');
                                const finishTimeBox = newRow.querySelector('.finish-time-box');
                                
                                const timeElapsed = timerData.timestamp ? 
                                    Math.floor((Date.now() - timerData.timestamp) / 1000) : 0;
                                let remainingSeconds = Math.max(0, (timerData.remainingSeconds || 0) - timeElapsed);
                                
                                timerStates[rowNumber] = {
                                    isRunning: true,
                                    remainingSeconds: remainingSeconds,
                                    finishTime: timerData.finishTime ? new Date(timerData.finishTime) : null
                                };
                                
                                startButton.disabled = true;
                                startButton.classList.add('bg-green-500', 'text-white');
                                stopButton.disabled = false;
                                
                                if (timerData.finishTime) {
                                    finishTimeBox.textContent = formatFinishTime(new Date(timerData.finishTime));
                                    finishTimeBox.classList.remove('hidden');
                                }
                                
                                const updateTimer = async () => {
                                    if (remainingSeconds <= 0) {
                                        clearInterval(activeIntervals[rowNumber]);
                                        delete activeIntervals[rowNumber];
                                        
                                        timerStates[rowNumber].isRunning = false;
                                        timerStates[rowNumber].remainingSeconds = 0;
                                        timerStates[rowNumber].finishTime = null;
                                        
                                        await saveTimerToFirebase(rowNumber, {
                                            name: timerData.name,
                                            timer: '00:00:00',
                                            timerInputValue: timerData.timerInputValue,
                                            startDisabled: false,
                                            stopDisabled: true,
                                            timerVisible: false,
                                            isRunning: false,
                                            remainingSeconds: 0,
                                            finishTime: null
                                        });

                                        finishTimeBox.classList.add('hidden');

                                        if (!shownNotifications.has(rowNumber)) {
                                            shownNotifications.add(rowNumber);
                                            showNotification(
                                                'Timer Selesai', 
                                                `Timer #${rowNumber} (${timerData.name || 'Tanpa Nama'}) telah berhenti`, 
                                                'info'
                                            );
                                        }
                                        return;
                                    }
                                    
                                    timerStates[rowNumber].remainingSeconds = remainingSeconds - 1;
                                    const h = String(Math.floor(timerStates[rowNumber].remainingSeconds / 3600)).padStart(2, '0');
                                    const m = String(Math.floor((timerStates[rowNumber].remainingSeconds % 3600) / 60)).padStart(2, '0');
                                    const s = String(timerStates[rowNumber].remainingSeconds % 60).padStart(2, '0');
                                    timerDisplay.textContent = `${h}:${m}:${s}`;
                                    remainingSeconds--;
                                };
                                
                                const h = String(Math.floor(remainingSeconds / 3600)).padStart(2, '0');
                                const m = String(Math.floor((remainingSeconds % 3600) / 60)).padStart(2, '0');
                                const s = String(remainingSeconds % 60).padStart(2, '0');
                                timerDisplay.textContent = `${h}:${m}:${s}`;
                                timerDisplay.classList.remove('hidden');
                                
                                activeIntervals[rowNumber] = setInterval(updateTimer, 1000);
                            } else if (timerData.remainingSeconds > 0) {
                                timerStates[rowNumber] = {
                                    isRunning: false,
                                    remainingSeconds: timerData.remainingSeconds,
                                    finishTime: timerData.finishTime ? new Date(timerData.finishTime) : null
                                };
                                
                                const timerDisplay = newRow.querySelector('.timer-display-box');
                                const h = String(Math.floor(timerData.remainingSeconds / 3600)).padStart(2, '0');
                                const m = String(Math.floor((timerData.remainingSeconds % 3600) / 60)).padStart(2, '0');
                                const s = String(timerData.remainingSeconds % 60).padStart(2, '0');
                                timerDisplay.textContent = `${h}:${m}:${s}`;
                                timerDisplay.classList.remove('hidden');
                                
                                if (timerData.finishTime) {
                                    const finishTimeBox = newRow.querySelector('.finish-time-box');
                                    finishTimeBox.textContent = formatFinishTime(new Date(timerData.finishTime));
                                    finishTimeBox.classList.remove('hidden');
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error in timer update:", error);
                    showNotification('Error', 'Terjadi kesalahan saat memuat timer', 'error');
                }
            });

            document.getElementById('add-row-btn').addEventListener('click', addNewRow);
            document.getElementById('wib-to-utc').addEventListener('click', convertWIBtoUTC);
            document.getElementById('utc-to-wib').addEventListener('click', convertUTCtoWIB);
            document.getElementById('wib-time').addEventListener('input', convertWIBtoUTC);
            document.getElementById('utc-time').addEventListener('input', convertUTCtoWIB);
            
            const now = new Date();
            const wibTimeInput = document.getElementById('wib-time');
            wibTimeInput.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
            convertWIBtoUTC();
            
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });
    </script>
</body>
</html>
