<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        .btn:active {
            transform: scale(0.95);
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            background: linear-gradient(270deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 1400% 1400%;
            animation: rainbow 60s ease infinite;
        }
        .login-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="login-container hidden">
        <button id="google-login" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">Login dengan Google</button>
        <button id="logout" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>
    <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto w-full max-w-7xl" id="timer-table-container">
        <table class="min-w-full divide-y divide-gray-200" id="timer-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Timer</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stop</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hapus</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
        </table>
        <div class="mt-4 text-center">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Tambah Tabel Baru</button>
        </div>
    </div>
    <script>
        // (function() {
        //     emailjs.init("YOUR_USER_ID"); // Replace with your EmailJS user ID
        // })();

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDXjv3Yg8RJvxCrYYZvMjpEKSdxcshynTo",
            authDomain: "pangestu-timer.firebaseapp.com",
            projectId: "pangestu-timer",
            storageBucket: "pangestu-timer.firebasestorage.app",
            messagingSenderId: "423055274704",
            appId: "1:423055274704:web:3e9e438bc18439012364d5",
            measurementId: "G-0249BJFL8T" // Optional, but included
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const loginContainer = document.querySelector('.login-container');
        const timerTableContainer = document.getElementById('timer-table-container');
        const googleLoginButton = document.getElementById('google-login');
        const logoutButton = document.getElementById('logout');

        // function sendEmail(name, rowNumber) {
        //     const templateParams = {
        //         to_name: 'namashirhai@gmail.com',
        //         message: `Timer pada kolom nama, contoh no ${rowNumber} nama ${name} telah habis`
        //     };

        //     emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams) // Replace with your EmailJS service ID and template ID
        //         .then(function(response) {
        //             console.log('SUCCESS!', response.status, response.text);
        //         }, function(error) {
        //             console.log('FAILED...', error);
        //         });
        // }

        function formatTime(totalSeconds) {
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function parseTimeString(timeString) {
            const [h, m, s] = timeString.split(':').map(Number);
            return (h * 3600) + (m * 60) + s;
        }

        function addEventListenersToRow(row, userId) {
            const startButton = row.querySelector('.start-btn');
            const stopButton = row.querySelector('.stop-btn');
            const deleteButton = row.querySelector('.delete-btn');
            const timerElement = row.querySelector('.timer');
            const nameInput = row.querySelector('input[type="text"]');
            const rowNumber = row.querySelector('td').textContent;
            let intervalId;

            const timerKey = `timer-${rowNumber}`; // Unique key for each timer

            startButton.addEventListener('click', () => {
                let [hours, minutes, seconds] = timerElement.textContent.split(':').map(Number);
                let totalSeconds = hours * 3600 + minutes * 60 + seconds;

                if (!userId) {
                    alert('Silakan login terlebih dahulu.');
                    return;
                }

                const startTime = Date.now();
                const timerData = {
                    name: nameInput.value,
                    duration: totalSeconds,
                    startTime: startTime,
                    isRunning: true
                };

                database.ref(`users/${userId}/timers/${timerKey}`).set(timerData)
                    .then(() => console.log('Timer data saved'))
                    .catch(error => console.error('Error saving timer:', error));

                intervalId = setInterval(() => {
                    totalSeconds--;
                    timerElement.textContent = formatTime(totalSeconds);
                    if (totalSeconds <= 0) {
                        clearInterval(intervalId);
                        // sendEmail(nameInput.value, rowNumber); // Komentar baris ini
                        // Update status di Firebase saat selesai (opsional)
                        database.ref(`users/${userId}/timers/${timerKey}/isRunning`).set(false);
                    }
                    // Update durasi di Firebase secara berkala (opsional)
                    // database.ref(`users/${userId}/timers/${timerKey}/duration`).set(totalSeconds);
                }, 1000);

                startButton.disabled = true;
                startButton.classList.add('bg-green-500', 'text-white');
                stopButton.disabled = false;
            });

            stopButton.addEventListener('click', () => {
                clearInterval(intervalId);
                if (userId) {
                    database.ref(`users/${userId}/timers/${timerKey}/isRunning`).set(false);
                }
                startButton.disabled = false;
                startButton.classList.remove('bg-green-500', 'text-white');
                stopButton.disabled = true;
            });

            deleteButton.addEventListener('click', () => {
                if (userId) {
                    database.ref(`users/${userId}/timers/${timerKey}`).remove()
                        .then(() => {
                            row.remove();
                            updateRowNumbers();
                        })
                        .catch(error => console.error('Error deleting timer:', error));
                }
            });

            nameInput.addEventListener('input', () => {
                if (userId) {
                    database.ref(`users/${userId}/timers/${timerKey}/name`).set(nameInput.value);
                }
            });
        }

        function updateRowNumbers() {
            document.querySelectorAll('#timer-table tbody tr').forEach((row, index) => {
                row.querySelector('td').textContent = index + 1;
            });
        }

        function addRow(name = 'Timer Baru', duration = '24:00:00', isRunning = false, startTime = null) {
            const tableBody = document.querySelector('#timer-table tbody');
            const rowCount = tableBody.rows.length + 1;
            const newRow = document.createElement('tr');
            const timerDisplay = isRunning && startTime ? formatTime(Math.max(0, parseTimeString(duration) - Math.floor((Date.now() - startTime) / 1000))) : duration;

            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${rowCount}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="text" placeholder="Masukkan Nama" class="border border-gray-300 rounded px-2 py-1 w-full" value="${name}">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="bg-gray-800 text-white text-center rounded px-4 py-2 timer text-lg">${timerDisplay}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-white border border-gray-300 rounded px-2 py-1 start-btn btn w-full" ${isRunning ? 'disabled' : ''}>Mulai</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-gray-200 border border-gray-300 rounded px-2 py-1 stop-btn btn w-full" ${!isRunning ? 'disabled' : ''}>Stop</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button class="bg-red-500 text-white border border-gray-300 rounded px-2 py-1 delete-btn btn w-full">Hapus</button>
                </td>
            `;
            tableBody.appendChild(newRow);
            const userId = auth.currentUser ? auth.currentUser.uid : null;
            addEventListenersToRow(newRow, userId);
        }

        document.getElementById('add-row-btn').addEventListener('click', () => {
            addRow();
        });

        function loadTimers(userId) {
            if (!userId) return;
            database.ref(`users/${userId}/timers`).on('value', (snapshot) => {
                const tableBody = document.querySelector('#timer-table tbody');
                tableBody.innerHTML = ''; // Clear existing rows
                const timers = snapshot.val();
                if (timers) {
                    let index = 1;
                    for (const key in timers) {
                        if (timers.hasOwnProperty(key)) {
                            const timerData = timers[key];
                            const remainingTime = timerData.isRunning && timerData.startTime ? Math.max(0, timerData.duration - Math.floor((Date.now() - timerData.startTime) / 1000)) : parseTimeString(formatTime(timerData.duration / 1000));
                            addRow(timerData.name, formatTime(timerData.duration / 1000), timerData.isRunning, timerData.startTime);
                            // You might need to adjust the display of the timer based on isRunning and startTime
                        }
                    }
                    updateRowNumbers();
                }
            });
        }

        // Authentication
        googleLoginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Login berhasil:', result.user.uid);
                    loginContainer.classList.add('hidden');
                    timerTableContainer.classList.remove('hidden');
                    loadTimers(result.user.uid);
                })
                .catch((error) => {
                    console.error('Error saat login:', error);
                    alert('Gagal login. Silakan coba lagi.');
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log('Logout berhasil');
                loginContainer.classList.remove('hidden');
                timerTableContainer.classList.add('hidden');
                // Clear the table
                document.querySelector('#timer-table tbody').innerHTML = '';
            }).catch((error) => {
                console.error('Error saat logout:', error);
                alert('Gagal logout. Silakan coba lagi.');
            });
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User is signed in:', user.uid);
                loginContainer.classList.add('hidden');
                timerTableContainer.classList.remove('hidden');
                loadTimers(user.uid);
            } else {
                console.log('No user is signed in.');
                loginContainer.classList.remove('hidden');
                timerTableContainer.classList.add('hidden');
                document.querySelector('#timer-table tbody').innerHTML = '';
            }
        });

        // Load initial state (if any) - not needed for Firebase as it's real-time
        // window.addEventListener('load', () => {
        //     loadTableState();
        //     loadTimerState();
        // });
    </script>
</body>
</html>